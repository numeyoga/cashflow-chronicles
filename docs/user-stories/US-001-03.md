# US-001-03 : Sauvegarder les données en fichier TOML

## Informations générales

- **Epic parent** : EPIC-001 - Stockage et Parser TOML
- **Priorité** : Critique
- **Complexité** : Moyenne
- **Sprint** : Sprint 1

## Prérequis

- **US-001-01** : Charger un fichier TOML valide
- Données modifiées en mémoire (comptes, transactions, etc.)

## Profil utilisateur

**Utilisateur final** qui a effectué des modifications et souhaite les enregistrer

## Objectif business

Persister les modifications de l'utilisateur dans le fichier TOML pour garantir qu'aucune donnée ne soit perdue.

## Objectifs concrets

1. Sérialiser les données en mémoire au format TOML v1.0.0
2. Écrire le fichier sur le système de fichiers
3. Mettre à jour le timestamp `metadata.lastModified`
4. Valider que le fichier est bien écrit
5. Afficher une confirmation de sauvegarde
6. Garantir une sauvegarde en moins de 500ms

## Scénario nominal

### Étapes

1. L'utilisateur modifie des données (ajoute une transaction, un compte, etc.)
2. L'utilisateur clique sur "Enregistrer" ou Ctrl+S
3. L'application met à jour `metadata.lastModified` avec la date/heure actuelle
4. L'application sérialise toutes les données en format TOML
5. L'application écrit le contenu dans le fichier
6. L'application vérifie que l'écriture a réussi
7. L'application affiche un message de confirmation : "✓ Enregistré à HH:MM:SS"
8. L'indicateur de modifications non sauvegardées disparaît

## Données de test

### Données entrantes (état en mémoire)

```javascript
{
  version: "1.0.0",
  metadata: {
    created: Date("2025-01-01T00:00:00Z"),
    lastModified: Date("2025-01-15T10:30:00Z"), // Sera mis à jour
    defaultCurrency: "CHF",
    owner: "Test User"
  },
  currencies: [
    { code: "CHF", name: "Swiss Franc", symbol: "CHF", decimalPlaces: 2, isDefault: true }
  ],
  accounts: [
    { id: "acc_001", name: "Assets:Bank:CHF", type: "Assets", currency: "CHF", opened: Date("2025-01-01") },
    { id: "acc_002", name: "Expenses:Food", type: "Expenses", currency: "CHF", opened: Date("2025-01-01") }
  ],
  transactions: [
    {
      id: "txn_001",
      date: Date("2025-01-15"),
      description: "Courses",
      postings: [
        { accountId: "acc_002", amount: 50.00, currency: "CHF" },
        { accountId: "acc_001", amount: -50.00, currency: "CHF" }
      ]
    }
  ],
  budgets: [],
  recurring: []
}
```

### Données sortantes (fichier TOML)

**Fichier** : `cashflow-data.toml`

```toml
version = "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-15T14:25:33Z"  # Mis à jour automatiquement
defaultCurrency = "CHF"
owner = "Test User"

[[currency]]
code = "CHF"
name = "Swiss Franc"
symbol = "CHF"
decimalPlaces = 2
isDefault = true

[[account]]
id = "acc_001"
name = "Assets:Bank:CHF"
type = "Assets"
currency = "CHF"
opened = "2025-01-01"

[[account]]
id = "acc_002"
name = "Expenses:Food"
type = "Expenses"
currency = "CHF"
opened = "2025-01-01"

[[transaction]]
id = "txn_001"
date = "2025-01-15"
description = "Courses"

  [[transaction.posting]]
  accountId = "acc_002"
  amount = 50.0
  currency = "CHF"

  [[transaction.posting]]
  accountId = "acc_001"
  amount = -50.0
  currency = "CHF"
```

### Message de confirmation attendu

```
✓ Enregistré à 14:25:33
```

## Critères d'acceptation

- [ ] Les données sont correctement sérialisées au format TOML v1.0.0
- [ ] Le fichier est écrit sur le système de fichiers
- [ ] `metadata.lastModified` est mis à jour automatiquement
- [ ] L'encodage UTF-8 est préservé
- [ ] L'indentation est propre (2 espaces recommandés)
- [ ] La sauvegarde prend moins de 500ms
- [ ] Un message de confirmation est affiché
- [ ] L'indicateur "modifications non sauvegardées" disparaît
- [ ] Le fichier peut être rechargé immédiatement sans erreur

## Gestion des erreurs

### Erreur : Espace disque insuffisant

```
❌ Impossible d'enregistrer le fichier

Erreur : Espace disque insuffisant

Suggestion : Libérez de l'espace sur votre disque et réessayez.
```

### Erreur : Permission refusée

```
❌ Impossible d'enregistrer le fichier

Erreur : Permission refusée

Suggestion : Vérifiez que vous avez les droits d'écriture sur ce fichier.
```

### Erreur : Fichier en lecture seule

```
❌ Impossible d'enregistrer le fichier

Erreur : Le fichier est en lecture seule

Suggestion : Modifiez les permissions du fichier ou enregistrez sous un autre nom.
```

## Notes techniques

- Utiliser `smol-toml` ou `@ltd/j-toml` pour la sérialisation
- Convertir les objets Date JavaScript en format ISO 8601 pour TOML
- Trier les sections dans l'ordre standard : metadata, currency, account, transaction, budget, recurring
- Préserver les commentaires existants si possible (dépend du parser)
- Ajouter un indicateur visuel pendant la sauvegarde (spinner)
- Désactiver les modifications pendant la sauvegarde

## Indicateur de modifications non sauvegardées

- Afficher un point orange à côté du nom du fichier si des modifications existent
- Afficher "●" dans le titre de la fenêtre
- Proposer d'enregistrer avant de fermer l'application

## Performance

- **Objectif** : < 500ms pour sauvegarder 10 000 transactions
- Optimisation : Sérialisation en streaming si nécessaire

## Dépendances

- US-001-01 : Charger un fichier TOML valide
- Système de fichiers accessible en écriture
