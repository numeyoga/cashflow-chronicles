# US-002-02 : Enregistrer un taux de change historique

## Informations g√©n√©rales

- **Epic parent** : EPIC-002 - Gestion des Devises et Taux de Change
- **Priorit√©** : Critique
- **Complexit√©** : Moyenne
- **Sprint** : Sprint 2

## Pr√©requis

- **US-002-01** : Ajouter une nouvelle devise
- Au moins 2 devises configur√©es dont une par d√©faut

## Profil utilisateur

**Utilisateur** qui effectue des transactions multi-devises et a besoin d'enregistrer les taux de change utilis√©s

## Objectif business

Permettre de convertir avec pr√©cision les montants entre devises en utilisant des taux de change historiques, essentiels pour la comptabilit√© multi-devises.

## Objectifs concrets

1. Enregistrer un taux de change pour une date donn√©e
2. Associer le taux √† une devise (ex: EUR ‚Üí CHF)
3. Valider que le taux est > 0
4. Permettre de mettre √† jour un taux existant
5. Afficher l'historique des taux pour une devise
6. Utiliser le taux le plus r√©cent par d√©faut lors des transactions

## Sc√©nario nominal

### √âtapes

1. L'utilisateur acc√®de √† **Param√®tres > Devises**
2. L'utilisateur s√©lectionne une devise (ex: EUR)
3. L'utilisateur clique sur **[Ajouter un taux de change]**
4. Un formulaire s'affiche :
   - Date : `2025-01-15`
   - Taux : `0.95` (1 EUR = 0.95 CHF)
   - Source : `Banque PostFinance` (optionnel)
5. L'utilisateur clique sur **[Enregistrer]**
6. L'application valide les donn√©es (V-CUR-008 √† V-CUR-012)
7. L'application ajoute le taux en m√©moire
8. L'application sauvegarde le fichier TOML
9. L'application affiche : "‚úì Taux de change EUR ajout√© pour le 15/01/2025"
10. Le taux appara√Æt dans l'historique de la devise EUR

## Donn√©es de test

### Donn√©es entrantes (formulaire)

```javascript
{
  date: "2025-01-15",
  rate: 0.95,
  source: "Banque PostFinance"  // Optionnel
}
```

### Donn√©es sortantes (fichier TOML)

```toml
[[currency]]
code = "EUR"
name = "Euro"
symbol = "‚Ç¨"
decimalPlaces = 2

  [[currency.exchangeRate]]
  date = "2025-01-15"
  rate = 0.95
  source = "Banque PostFinance"

  [[currency.exchangeRate]]
  date = "2025-01-20"
  rate = 0.94
  source = "Banque PostFinance"
```

### Interpr√©tation du taux

```
rate = 0.95 signifie : 1 EUR = 0.95 CHF

Formule de conversion :
  Montant_CHF = Montant_EUR √ó 0.95

Exemples :
  100 EUR √ó 0.95 = 95 CHF
  50 EUR √ó 0.95 = 47.50 CHF
  1000 EUR √ó 0.95 = 950 CHF
```

**Note** : Le taux est toujours exprim√© par rapport √† la devise par d√©faut (CHF dans cet exemple).

### Affichage dans l'interface

```
üí± EUR - Euro

üìä Historique des taux de change

Date         | Taux    | Source                 | Actions
-------------|---------|------------------------|----------
20/01/2025   | 0.9400  | Banque PostFinance    | [‚úèÔ∏è] [üóëÔ∏è]
15/01/2025   | 0.9500  | Banque PostFinance    | [‚úèÔ∏è] [üóëÔ∏è]
10/01/2025   | 0.9600  | Manuel                | [‚úèÔ∏è] [üóëÔ∏è]

[+ Ajouter un taux de change]

üìà Graphique d'√©volution (derniers 30 jours)
```

## Crit√®res d'acceptation

- [ ] Le formulaire d'ajout de taux est accessible
- [ ] La date doit √™tre au format YYYY-MM-DD
- [ ] Le taux doit √™tre > 0
- [ ] Un avertissement est affich√© si taux = 1.0 (V-CUR-010)
- [ ] Les dates sont uniques (un seul taux par jour) (V-CUR-011)
- [ ] La devise par d√©faut ne peut pas avoir de taux (V-CUR-012)
- [ ] Le taux est sauvegard√© dans le fichier TOML
- [ ] L'historique est tri√© par date d√©croissante
- [ ] Le taux le plus r√©cent est utilis√© par d√©faut pour les transactions

## Validation

### R√®gles appliqu√©es

- **V-CUR-008** : Date au format YYYY-MM-DD
- **V-CUR-009** : Taux > 0
- **V-CUR-010** : Avertissement si taux = 1.0
- **V-CUR-011** : Dates uniques
- **V-CUR-012** : Pas de taux pour la devise par d√©faut

### Messages d'erreur

#### Taux n√©gatif ou z√©ro

```
‚ùå Taux de change invalide : 0

Le taux de change doit √™tre sup√©rieur √† 0.

Exemple : 0.95 signifie 1 EUR = 0.95 CHF
```

#### Date en doublon

```
‚ùå Taux d√©j√† existant pour cette date

Un taux de change existe d√©j√† pour le 15/01/2025 (0.9500).

Actions possibles :
  [Modifier le taux existant]
  [Choisir une autre date]
```

#### Taux √©gal √† 1.0 (avertissement)

```
‚ö†Ô∏è Taux de change √©gal √† 1.0

Un taux de 1.0 signifie que EUR et CHF ont la m√™me valeur.

√ätes-vous s√ªr de vouloir enregistrer ce taux ?

[Oui, enregistrer] [Non, modifier]
```

#### Tentative d'ajouter un taux pour la devise par d√©faut

```
‚ùå Impossible d'ajouter un taux de change

CHF est la devise par d√©faut du syst√®me.
Les taux de change ne peuvent pas √™tre d√©finis pour la devise par d√©faut.

Suggestion : Ajoutez des taux pour les autres devises (EUR, USD, etc.)
```

## Calcul du taux applicable pour une transaction

Lorsqu'une transaction multi-devises est cr√©√©e, le syst√®me doit trouver le taux applicable :

```typescript
function getExchangeRate(currency: string, date: Date): number {
  const currencyData = currencies.find(c => c.code === currency);
  if (!currencyData) throw new Error('Currency not found');

  // Trouver le taux le plus r√©cent <= date de transaction
  const applicableRates = currencyData.exchangeRates
    .filter(r => r.date <= date)
    .sort((a, b) => b.date - a.date);

  if (applicableRates.length === 0) {
    throw new Error(`No exchange rate found for ${currency} at ${date}`);
  }

  return applicableRates[0].rate;
}
```

### Exemple d'utilisation

```
Historique EUR :
  - 2025-01-20 : 0.94
  - 2025-01-15 : 0.95
  - 2025-01-10 : 0.96

Transaction du 18/01/2025 :
  ‚Üí Taux utilis√© : 0.95 (le plus r√©cent <= 18/01)

Transaction du 22/01/2025 :
  ‚Üí Taux utilis√© : 0.94 (le plus r√©cent <= 22/01)

Transaction du 08/01/2025 :
  ‚Üí Erreur : Aucun taux disponible avant cette date
```

## Graphique d'√©volution des taux

Afficher un graphique lin√©aire montrant l'√©volution du taux sur les 30 derniers jours :

```
Taux EUR/CHF (30 derniers jours)

1.00 ‚î§
0.98 ‚î§
0.96 ‚î§     ‚Ä¢‚îÄ‚Ä¢
0.94 ‚î§           ‚Ä¢‚îÄ‚Ä¢‚îÄ‚Ä¢
0.92 ‚î§                    ‚Ä¢
0.90 ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     1/1   10/1   20/1   30/1
```

## Mise √† jour d'un taux existant

L'utilisateur peut modifier un taux existant :

1. Cliquer sur [‚úèÔ∏è] dans l'historique
2. Modifier le taux (ex: 0.95 ‚Üí 0.94)
3. Cliquer sur [Enregistrer]
4. **‚ö†Ô∏è Avertissement** : "Ce taux est utilis√© dans 5 transactions. La modification affectera les calculs."
5. Confirmer ou annuler

## Suppression d'un taux

L'utilisateur peut supprimer un taux :

1. Cliquer sur [üóëÔ∏è] dans l'historique
2. **‚ö†Ô∏è V√©rification** : "Ce taux est utilis√© dans 3 transactions. Voulez-vous vraiment le supprimer ?"
3. Si des transactions utilisent ce taux : bloquer la suppression
4. Si aucune transaction : supprimer

## Notes techniques

### Structure de donn√©es en m√©moire

```typescript
interface Currency {
  code: string;
  name: string;
  symbol: string;
  decimalPlaces: number;
  isDefault?: boolean;
  exchangeRates: ExchangeRate[];
}

interface ExchangeRate {
  date: Date;
  rate: number;
  source?: string;
}
```

### Tri des taux

Toujours afficher les taux du plus r√©cent au plus ancien :

```typescript
currency.exchangeRates.sort((a, b) => b.date - a.date);
```

### Validation de coh√©rence avec transactions

Avant de modifier ou supprimer un taux, v√©rifier s'il est utilis√© dans des transactions :

```typescript
function isRateUsedInTransactions(currency: string, date: Date): boolean {
  return transactions.some(tx =>
    tx.postings.some(p =>
      p.currency === currency &&
      p.exchangeRate &&
      p.exchangeRate.date === date
    )
  );
}
```

## D√©pendances

- US-002-01 : Ajouter une nouvelle devise
- US-001-03 : Sauvegarder les donn√©es en fichier TOML
- Biblioth√®que de graphiques (Chart.js, Recharts, etc.) pour l'√©volution
