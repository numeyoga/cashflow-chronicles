# US-001-05 : Valider la structure du fichier TOML au chargement

## Informations g√©n√©rales

- **Epic parent** : EPIC-001 - Stockage et Parser TOML
- **Priorit√©** : Critique
- **Complexit√©** : Moyenne
- **Sprint** : Sprint 1

## Pr√©requis

- **US-001-01** : Charger un fichier TOML valide
- **US-001-02** : G√©rer les erreurs de parsing TOML

## Profil utilisateur

**Utilisateur final** qui charge un fichier TOML syntaxiquement valide mais structurellement incorrect

## Objectif business

Garantir l'int√©grit√© des donn√©es d√®s le chargement en validant que le fichier respecte le sch√©ma attendu de Cashflow Chronicles.

## Objectifs concrets

1. Valider la pr√©sence de la propri√©t√© `version`
2. Valider le format semver de la version (X.Y.Z)
3. Valider la pr√©sence de toutes les sections obligatoires
4. Valider les types de donn√©es dans chaque section
5. Valider les contraintes basiques (codes ISO, formats de dates, etc.)
6. Afficher un rapport de validation clair
7. Bloquer le chargement si erreurs critiques

## Sc√©nario nominal

### √âtapes

1. L'utilisateur s√©lectionne un fichier TOML
2. L'application parse le fichier (US-001-01)
3. L'application lance la validation structurelle :
   - V√©rifie la pr√©sence et le format de `version`
   - V√©rifie la pr√©sence des sections obligatoires
   - V√©rifie les types de donn√©es
   - V√©rifie les formats (ISO 4217, ISO 8601, etc.)
4. Si validation OK : charger les donn√©es et afficher le dashboard
5. Si erreurs critiques : afficher le rapport et bloquer le chargement
6. Si avertissements seulement : charger les donn√©es et afficher les avertissements

## Donn√©es de test

### Cas 1 : Version manquante

**Fichier** : `test-no-version.toml`

```toml
[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-01T00:00:00Z"
defaultCurrency = "CHF"
```

**Erreur attendue** :

```
‚ùå Validation √©chou√©e : V-FILE-003

La propri√©t√© 'version' est obligatoire.

Le fichier TOML doit commencer par :
  version = "1.0.0"

Action : Ajoutez cette ligne au d√©but du fichier.
```

### Cas 2 : Format de version invalide

**Fichier** : `test-invalid-version.toml`

```toml
version = "1.0"  # Devrait √™tre "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
```

**Erreur attendue** :

```
‚ùå Validation √©chou√©e : V-FILE-004

La version doit suivre le format semver (X.Y.Z).
Trouv√© : "1.0"
Attendu : "1.0.0"

Action : Modifiez la version au format X.Y.Z (ex: 1.0.0, 2.1.3).
```

### Cas 3 : Section obligatoire manquante

**Fichier** : `test-missing-currency.toml`

```toml
version = "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-01T00:00:00Z"
defaultCurrency = "CHF"

# Section [[currency]] manquante

[[account]]
id = "acc_001"
name = "Assets:Bank:CHF"
type = "Assets"
currency = "CHF"
opened = "2025-01-01"
```

**Erreur attendue** :

```
‚ùå Validation √©chou√©e : V-FILE-005

Sections obligatoires manquantes :
  - [[currency]]

Action : Ajoutez au minimum :

[[currency]]
code = "CHF"
name = "Swiss Franc"
symbol = "CHF"
decimalPlaces = 2
isDefault = true
```

### Cas 4 : Code devise invalide (non ISO 4217)

**Fichier** : `test-invalid-currency-code.toml`

```toml
version = "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-01T00:00:00Z"
defaultCurrency = "SWISS"  # Devrait √™tre "CHF"

[[currency]]
code = "SWISS"  # Invalide, devrait √™tre 3 lettres ISO 4217
name = "Swiss Franc"
symbol = "CHF"
decimalPlaces = 2
isDefault = true
```

**Erreur attendue** :

```
‚ùå Validation √©chou√©e : V-CUR-001

Code devise invalide : "SWISS"

Les codes de devises doivent suivre la norme ISO 4217 (3 lettres majuscules).
Exemples valides : CHF, EUR, USD, GBP, JPY

Action : Remplacez "SWISS" par "CHF"
```

### Cas 5 : Date invalide

**Fichier** : `test-invalid-date.toml`

```toml
version = "1.0.0"

[metadata]
created = "01/01/2025"  # Format invalide, devrait √™tre "2025-01-01"
lastModified = "2025-01-01T00:00:00Z"
defaultCurrency = "CHF"
```

**Erreur attendue** :

```
‚ùå Validation √©chou√©e : V-META-001

Format de date invalide pour 'created' : "01/01/2025"

Les dates doivent suivre le format ISO 8601 :
  - Date simple : YYYY-MM-DD (ex: 2025-01-01)
  - Datetime : YYYY-MM-DDTHH:MM:SSZ (ex: 2025-01-01T14:30:00Z)

Action : Remplacez "01/01/2025" par "2025-01-01T00:00:00Z"
```

## Rapport de validation complet

```
üìã Rapport de validation

Fichier : cashflow-data.toml
Version : 1.0.0
Taille : 12.5 KB

‚úì Structure TOML valide
‚úì Version correcte
‚úì Toutes les sections pr√©sentes
‚úì 1 devise(s)
‚úì 15 compte(s)
‚úì 142 transaction(s)
‚úì 3 budget(s)
‚úì 2 r√©currence(s)

‚ùå Erreurs critiques (2)
  [V-CUR-001] Devise "acc_010" : Code "DOLLAR" invalide (devrait √™tre "USD")
  [V-ACC-004] Compte "acc_012" : Nom en doublon avec "acc_005"

‚ö†Ô∏è  Avertissements (1)
  [V-SOL-001] Compte "Assets:Bank:CHF" : Solde n√©gatif (-150.00 CHF)

‚ÑπÔ∏è  Informations (3)
  [V-LOG-002] Transaction txn_042 : Revenu standard d√©tect√©
  [V-LOG-002] Transaction txn_043 : Revenu standard d√©tect√©
  [V-LOG-003] Transaction txn_044 : D√©pense standard d√©tect√©e

‚ùå Le fichier ne peut pas √™tre charg√© en raison de 2 erreurs critiques.

[Voir les d√©tails] [Annuler]
```

## Crit√®res d'acceptation

- [ ] La validation d√©tecte l'absence de `version`
- [ ] La validation d√©tecte un format de version invalide
- [ ] La validation d√©tecte les sections manquantes
- [ ] La validation d√©tecte les codes devises non-ISO 4217
- [ ] La validation d√©tecte les formats de dates invalides
- [ ] La validation d√©tecte les types de donn√©es incorrects
- [ ] Un rapport d√©taill√© est g√©n√©r√© avec codes d'erreur
- [ ] Les erreurs critiques bloquent le chargement
- [ ] Les avertissements n'emp√™chent pas le chargement
- [ ] La validation prend < 100ms pour 1000 transactions

## R√®gles de validation structurelle

| R√®gle | Description | S√©v√©rit√© | Bloque le chargement |
|-------|-------------|----------|----------------------|
| V-FILE-001 | TOML valide | Erreur | Oui |
| V-FILE-002 | Encodage UTF-8 | Erreur | Oui |
| V-FILE-003 | Propri√©t√© `version` pr√©sente | Erreur | Oui |
| V-FILE-004 | Version format semver | Erreur | Oui |
| V-FILE-005 | Sections obligatoires pr√©sentes | Erreur | Oui |
| V-META-001 | Date `created` valide | Erreur | Oui |
| V-META-002 | Date `lastModified` valide | Erreur | Oui |
| V-CUR-001 | Code devise ISO 4217 | Erreur | Oui |
| V-ACC-003 | Nom de compte non vide | Erreur | Oui |

**Note** : Cette US couvre uniquement la validation structurelle de base. Les validations m√©tier complexes sont couvertes par **EPIC-006 : Syst√®me de Validation et R√®gles d'Int√©grit√©**.

## Notes techniques

- Cr√©er un module `validator.ts` s√©par√©
- Utiliser un syst√®me de codes d'erreur standardis√©s (V-XXX-YYY)
- Logger toutes les validations pour le d√©bogage
- Permettre de d√©sactiver certaines validations en mode d√©veloppement
- Impl√©menter la validation de mani√®re incr√©mentale (section par section)

## D√©pendances

- US-001-01 : Charger un fichier TOML valide
- US-001-02 : G√©rer les erreurs de parsing TOML
- Documentation des r√®gles de validation (VALIDATION-RULES.md)
