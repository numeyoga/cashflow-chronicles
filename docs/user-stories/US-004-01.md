# US-004-01 : Enregistrer une d√©pense simple (2 postings, 1 devise)

## Informations g√©n√©rales

- **Epic parent** : EPIC-004 - Gestion des Transactions Simples
- **Priorit√©** : Critique
- **Complexit√©** : Haute
- **Sprint** : Sprint 3

## Pr√©requis

- **US-003-01** : Cr√©er un compte bancaire (Assets)
- **US-003-02** : Cr√©er un compte de d√©penses (Expenses)
- Au moins 1 compte Assets et 1 compte Expenses configur√©s

## Profil utilisateur

**Utilisateur** qui souhaite enregistrer une d√©pense courante (courses, restaurant, transport, etc.)

## Objectif business

Permettre √† l'utilisateur d'enregistrer ses d√©penses quotidiennes pour suivre son budget et analyser ses finances.

## Objectifs concrets

1. Cr√©er une transaction avec 2 postings (partie double)
2. D√©biter un compte Expenses (montant positif)
3. Cr√©diter un compte Assets (montant n√©gatif)
4. Valider l'√©quilibre de la transaction (somme = 0)
5. Valider la coh√©rence des devises
6. Persister la transaction dans le fichier TOML
7. Afficher la transaction dans la liste
8. Mettre √† jour les soldes des comptes

## Sc√©nario nominal

### √âtapes

1. L'utilisateur acc√®de √† **Transactions**
2. L'utilisateur clique sur **[+ Nouvelle transaction]**
3. Un formulaire s'affiche avec les champs :
   - Date : `2025-01-15`
   - Description : `Courses au supermarch√© Migros`
   - B√©n√©ficiaire (payee) : `Migros` (optionnel)
   - Tags : `groceries, food` (optionnel)
   - **Postings** :
     - Posting 1 : `Expenses:Food:Groceries` | `120.50 CHF`
     - Posting 2 : `Assets:Bank:CHF:PostFinance` | `-120.50 CHF`
4. L'utilisateur saisit les informations
5. L'application affiche l'indicateur d'√©quilibre : "‚úì √âquilibr√©e (0.00 CHF)"
6. L'utilisateur clique sur **[Enregistrer]**
7. L'application valide les donn√©es (V-TXN-*, V-POST-*, V-BAL-001)
8. L'application g√©n√®re un ID unique (ex: `txn_001`)
9. L'application ajoute la transaction en m√©moire
10. L'application recalcule les soldes des comptes concern√©s
11. L'application sauvegarde le fichier TOML
12. L'application affiche : "‚úì Transaction enregistr√©e avec succ√®s"
13. La transaction appara√Æt dans la liste

## Donn√©es de test

### Donn√©es entrantes (formulaire)

```javascript
{
  date: "2025-01-15",
  description: "Courses au supermarch√© Migros",
  payee: "Migros",
  tags: ["groceries", "food"],
  postings: [
    {
      accountId: "acc_002",  // Expenses:Food:Groceries
      amount: 120.50,
      currency: "CHF"
    },
    {
      accountId: "acc_001",  // Assets:Bank:CHF:PostFinance
      amount: -120.50,
      currency: "CHF"
    }
  ]
}
```

### Donn√©es sortantes (fichier TOML)

```toml
[[transaction]]
id = "txn_001"
date = "2025-01-15"
description = "Courses au supermarch√© Migros"
payee = "Migros"
tags = ["groceries", "food"]

  [[transaction.posting]]
  accountId = "acc_002"
  amount = 120.5
  currency = "CHF"

  [[transaction.posting]]
  accountId = "acc_001"
  amount = -120.5
  currency = "CHF"
```

### Impact sur les soldes

**Avant la transaction :**
- `Assets:Bank:CHF:PostFinance` (acc_001) : 5'000.00 CHF
- `Expenses:Food:Groceries` (acc_002) : 0.00 CHF

**Apr√®s la transaction :**
- `Assets:Bank:CHF:PostFinance` (acc_001) : **4'879.50 CHF** (5000 - 120.50)
- `Expenses:Food:Groceries` (acc_002) : **120.50 CHF** (0 + 120.50)

### Affichage dans la liste des transactions

```
üìã Transactions

Date       | Description                        | Montant     | Comptes
-----------|------------------------------------| ------------|------------------
15/01/2025 | Courses au supermarch√© Migros     | -120.50 CHF | üõí Food:Groceries
           | üè∑Ô∏è groceries, food                |             | üí≥ Bank:CHF

[üìÑ D√©tails] [‚úèÔ∏è Modifier] [üóëÔ∏è Supprimer]
```

## Crit√®res d'acceptation

- [ ] Le formulaire de transaction est accessible
- [ ] Une transaction contient au minimum 2 postings
- [ ] La somme des montants doit √™tre 0 (tol√©rance ¬±0.01)
- [ ] Les devises de tous les postings doivent correspondre aux devises des comptes
- [ ] La date doit √™tre au format YYYY-MM-DD
- [ ] La date ne doit pas √™tre dans le futur (avertissement)
- [ ] Un ID unique est g√©n√©r√© automatiquement (format `txn_XXX`)
- [ ] La transaction est sauvegard√©e dans le fichier TOML
- [ ] Les soldes des comptes sont mis √† jour imm√©diatement
- [ ] Un message de confirmation est affich√©
- [ ] La transaction appara√Æt dans la liste tri√©e par date

## Validation

### R√®gles appliqu√©es

- **V-TXN-001** : ID au format `txn_XXX`
- **V-TXN-002** : ID unique
- **V-TXN-003** : Date au format YYYY-MM-DD
- **V-TXN-004** : Description non vide
- **V-TXN-005** : Au moins 2 postings
- **V-TXN-006** : Date pas dans le futur (avertissement)
- **V-POST-001** : accountId existe
- **V-POST-002** : amount ‚â† 0
- **V-POST-003** : currency correspond au compte
- **V-POST-004** : date >= date d'ouverture du compte
- **V-POST-005** : date <= date de fermeture du compte (si ferm√©)
- **V-BAL-001** : Somme des montants = 0 (tol√©rance ¬±0.01)

### Messages d'erreur

#### Transaction non √©quilibr√©e

```
‚ùå Transaction non √©quilibr√©e

Somme actuelle : -20.50 CHF

Une transaction doit √™tre √©quilibr√©e (somme = 0).

Postings actuels :
  Expenses:Food:Groceries        : +100.00 CHF
  Assets:Bank:CHF:PostFinance    : -120.50 CHF
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total                          : -20.50 CHF ‚ùå

Suggestions :
  - Modifiez le montant du premier posting √† 120.50
  - Ou ajoutez un posting suppl√©mentaire de +20.50 CHF
```

#### Description vide

```
‚ùå Description obligatoire

La description de la transaction ne peut pas √™tre vide.

Exemple : "Courses au supermarch√© Migros"
```

#### Montant z√©ro dans un posting

```
‚ùå Montant invalide

Le montant d'un posting ne peut pas √™tre 0.

Posting concern√© : Expenses:Food:Groceries

Action : Entrez un montant positif (d√©bit) ou n√©gatif (cr√©dit).
```

#### Devise ne correspond pas au compte

```
‚ùå Incoh√©rence de devise

Le compte "Assets:Bank:CHF:PostFinance" utilise la devise CHF.
Vous tentez d'enregistrer un montant en EUR.

Actions possibles :
  - Changez le compte pour un compte en EUR
  - Ou changez la devise du posting √† CHF
  - Ou utilisez une transaction multi-devises (EPIC-005)
```

#### Date dans le futur

```
‚ö†Ô∏è Date dans le futur

La date 25/12/2025 est dans le futur.

Voulez-vous vraiment enregistrer cette transaction ?

[Oui, enregistrer] [Non, modifier la date]
```

## Interface de saisie guid√©e

### Formulaire avec assistance

```
üìù Nouvelle transaction

Date *
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2025-01-15                      [üìÖ]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Description *
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Courses au supermarch√© Migros       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

B√©n√©ficiaire
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Migros                               ‚îÇ [Suggestions : Migros, Coop, ...]
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Tags (s√©par√©s par des virgules)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ groceries, food                      ‚îÇ [Suggestions : groceries, food, shopping]
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ Postings (minimum 2)

Posting 1
  Compte       : Expenses:Food:Groceries        [üîç]
  Montant      : 120.50
  Devise       : CHF                            [‚úì]

Posting 2
  Compte       : Assets:Bank:CHF:PostFinance    [üîç]
  Montant      : -120.50
  Devise       : CHF                            [‚úì]

[+ Ajouter un posting]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

√âquilibre : ‚úì 0.00 CHF (√©quilibr√©e)

[Annuler]  [Enregistrer]
```

### Indicateur d'√©quilibre en temps r√©el

L'indicateur d'√©quilibre se met √† jour automatiquement √† chaque modification :

```
‚úì 0.00 CHF (√©quilibr√©e)          ‚Üí Transaction valide
‚ö†Ô∏è +25.50 CHF (non √©quilibr√©e)   ‚Üí Transaction invalide
‚ö†Ô∏è -12.00 CHF (non √©quilibr√©e)   ‚Üí Transaction invalide
```

### Suggestions de comptes

Lorsque l'utilisateur tape dans le champ "Compte", afficher des suggestions :

```
[üîç] Assets:Bank:CHF:Post...

Suggestions :
  üí≥ Assets:Bank:CHF:PostFinance      (Solde : 5'000.00 CHF)
  üí≥ Assets:Bank:CHF:UBS              (Solde : 2'500.00 CHF)
  üí∞ Assets:Cash:CHF                  (Solde : 200.00 CHF)
```

## Raccourcis et mod√®les (templates)

### Mod√®les de transactions courantes

Pour acc√©l√©rer la saisie, proposer des mod√®les :

```
üìã Mod√®les de transactions

[üõí] Courses alimentaires
  ‚Üí Expenses:Food:Groceries
  ‚Üí Assets:Bank:CHF:PostFinance

[üöó] Essence / Transport
  ‚Üí Expenses:Transport:Fuel
  ‚Üí Assets:Bank:CHF:PostFinance

[‚òï] Restaurant / Caf√©
  ‚Üí Expenses:Food:Restaurants
  ‚Üí Assets:Bank:CHF:PostFinance

[+ Cr√©er un nouveau mod√®le]
```

### Duplication de transaction

Permettre de dupliquer une transaction existante :

```
[üìã Dupliquer]

Tous les champs sont pr√©-remplis.
Modifiez ce qui est n√©cessaire (date, montant, etc.).
```

## Calcul automatique du dernier posting

Pour faciliter la saisie, calculer automatiquement le montant du dernier posting :

```
Posting 1 : Expenses:Food:Groceries      +120.50 CHF
Posting 2 : Assets:Bank:CHF:PostFinance  [Auto : -120.50 CHF]

[‚úì] Calculer automatiquement le dernier posting
```

## Notes techniques

### G√©n√©ration de l'ID

```typescript
function generateTransactionId(existingTransactions: Transaction[]): string {
  const maxId = Math.max(
    0,
    ...existingTransactions.map(t => parseInt(t.id.replace('txn_', '')))
  );
  const nextId = maxId + 1;
  return `txn_${nextId.toString().padStart(3, '0')}`;
}
```

### Validation de l'√©quilibre

```typescript
function isBalanced(postings: Posting[]): boolean {
  const tolerance = 0.01;
  const sum = postings.reduce((acc, p) => acc + p.amount, 0);
  return Math.abs(sum) <= tolerance;
}
```

### Mise √† jour des soldes

```typescript
function updateAccountBalances(transaction: Transaction) {
  for (const posting of transaction.postings) {
    const account = accounts.find(a => a.id === posting.accountId);
    if (account) {
      account.balance += posting.amount;
    }
  }
}
```

**Note** : Les soldes ne sont pas stock√©s dans le fichier TOML, ils sont recalcul√©s √† chaque chargement.

## D√©pendances

- US-003-01 : Cr√©er un compte bancaire (Assets)
- US-003-02 : Cr√©er un compte de d√©penses (Expenses)
- US-001-03 : Sauvegarder les donn√©es en fichier TOML
- US-001-05 : Valider la structure du fichier TOML
