# US-001-06 : Sauvegarder automatiquement apr√®s chaque modification

## Informations g√©n√©rales

- **Epic parent** : EPIC-001 - Stockage et Parser TOML
- **Priorit√©** : Haute
- **Complexit√©** : Moyenne
- **Sprint** : Sprint 2

## Pr√©requis

- **US-001-03** : Sauvegarder les donn√©es en fichier TOML
- **US-001-04** : Cr√©er un backup automatique avant modification

## Profil utilisateur

**Utilisateur final** qui modifie fr√©quemment ses donn√©es et ne veut pas perdre son travail

## Objectif business

√âviter la perte de donn√©es en sauvegardant automatiquement apr√®s chaque modification, comme dans les applications modernes (Google Docs, Notion, etc.).

## Objectifs concrets

1. D√©tecter automatiquement les modifications de donn√©es
2. D√©clencher une sauvegarde apr√®s un d√©lai configurable (debounce)
3. Afficher un indicateur visuel de sauvegarde en cours
4. Afficher la confirmation de sauvegarde automatique
5. Permettre √† l'utilisateur de d√©sactiver l'auto-save
6. Garantir qu'aucune modification n'est perdue

## Sc√©nario nominal

### √âtapes

1. L'utilisateur modifie une donn√©e (ajoute une transaction, modifie un compte, etc.)
2. L'application marque les donn√©es comme "modifi√©es"
3. Un timer de debounce d√©marre (d√©lai par d√©faut : 2 secondes)
4. Si l'utilisateur fait une autre modification, le timer est r√©initialis√©
5. Apr√®s 2 secondes sans modification, la sauvegarde automatique d√©marre
6. L'application affiche un indicateur "üíæ Enregistrement..."
7. La sauvegarde s'ex√©cute (avec backup automatique)
8. L'application affiche "‚úì Enregistr√© automatiquement √† HH:MM:SS"
9. L'indicateur dispara√Æt apr√®s 3 secondes

## Donn√©es de test

### Configuration par d√©faut

```javascript
{
  autoSave: {
    enabled: true,
    debounceDelay: 2000,  // 2 secondes
    showNotification: true,
    notificationDuration: 3000  // 3 secondes
  }
}
```

### Sc√©nario de modifications rapides

```
T+0s   : Utilisateur ajoute une transaction ‚Üí Timer d√©marre (2s)
T+1s   : Utilisateur modifie le montant ‚Üí Timer r√©initialis√© (2s)
T+1.5s : Utilisateur modifie la description ‚Üí Timer r√©initialis√© (2s)
T+3.5s : Aucune autre modification ‚Üí Sauvegarde automatique d√©clench√©e
T+3.6s : Affichage "üíæ Enregistrement..."
T+3.8s : Sauvegarde termin√©e ‚Üí "‚úì Enregistr√© automatiquement √† 14:25:38"
T+6.8s : Notification dispara√Æt
```

### Indicateurs visuels

#### Pendant la modification (avant sauvegarde)

```
cashflow-data.toml ‚óè [Non enregistr√©]
```

#### Pendant la sauvegarde

```
üíæ Enregistrement en cours...
```

#### Apr√®s la sauvegarde

```
‚úì Enregistr√© automatiquement √† 14:25:38
```

## Crit√®res d'acceptation

- [ ] Les modifications d√©clenchent automatiquement une sauvegarde apr√®s le d√©lai de debounce
- [ ] Le d√©lai de debounce est configurable (d√©faut 2 secondes)
- [ ] Un indicateur visuel montre l'√©tat de sauvegarde
- [ ] L'utilisateur peut d√©sactiver l'auto-save dans les param√®tres
- [ ] L'auto-save ne bloque pas l'interface utilisateur
- [ ] Un backup est cr√©√© avant chaque auto-save
- [ ] L'utilisateur peut toujours sauvegarder manuellement (Ctrl+S)
- [ ] Aucune perte de donn√©es m√™me avec des modifications rapides
- [ ] L'auto-save fonctionne pour tous les types de modifications (comptes, transactions, budgets, etc.)

## Interface de param√©trage

### Section Param√®tres > Fichier > Sauvegarde automatique

```
‚öôÔ∏è Sauvegarde automatique

[‚úì] Activer la sauvegarde automatique

D√©lai avant sauvegarde : [2] secondes
  ‚ÑπÔ∏è Temps d'attente apr√®s la derni√®re modification

[‚úì] Afficher les notifications de sauvegarde

[‚úì] Cr√©er des backups automatiques avant chaque sauvegarde

Nombre de backups √† conserver : [10]

[Enregistrer] [Annuler]
```

### Configuration stock√©e dans les pr√©f√©rences locales

```javascript
// localStorage ou fichier de config s√©par√©
{
  "autoSave": {
    "enabled": true,
    "debounceDelay": 2000,
    "showNotification": true,
    "createBackup": true,
    "maxBackups": 10
  }
}
```

## Gestion des erreurs

### Erreur de sauvegarde automatique

Si l'auto-save √©choue (disque plein, permissions, etc.) :

```
‚ùå Erreur de sauvegarde automatique

L'enregistrement automatique a √©chou√©.
Vos modifications sont toujours en m√©moire.

Erreur : Espace disque insuffisant

Actions possibles :
  [Enregistrer manuellement]
  [D√©sactiver l'auto-save]
  [R√©essayer]
```

**Important** : Les donn√©es restent en m√©moire et ne sont pas perdues.

### Conflit de sauvegarde

Si l'utilisateur quitte pendant une sauvegarde automatique en cours :

```
‚ö†Ô∏è Sauvegarde en cours

Une sauvegarde automatique est en cours.

[Attendre la fin (2s restantes)] [Forcer la fermeture]
```

## Edge cases (dans des US s√©par√©es)

Ces cas particuliers seront trait√©s dans des US d√©di√©es :

- **US-001-07** : G√©rer les conflits de fichier (fichier modifi√© externement)
- **US-001-08** : G√©rer la perte de connexion/permission en cours de sauvegarde
- **US-001-09** : R√©cup√©rer apr√®s un crash (donn√©es non sauvegard√©es)

## Notes techniques

### Impl√©mentation du debounce

```typescript
let saveTimeout: NodeJS.Timeout | null = null;

function onDataChange() {
  // Annuler le timer pr√©c√©dent
  if (saveTimeout) {
    clearTimeout(saveTimeout);
  }

  // D√©marrer un nouveau timer
  saveTimeout = setTimeout(async () => {
    await autoSave();
  }, config.autoSave.debounceDelay);
}

async function autoSave() {
  try {
    showIndicator("saving");
    await saveToFile();  // US-001-03
    showIndicator("saved");
    setTimeout(() => hideIndicator(), 3000);
  } catch (error) {
    showIndicator("error", error.message);
  }
}
```

### D√©tection des modifications

Utiliser un syst√®me de listeners/observables pour d√©tecter les changements :

```typescript
// Exemple avec un state manager
store.subscribe((newState, oldState) => {
  if (hasDataChanged(newState, oldState)) {
    onDataChange();
  }
});
```

### Performance

- Le debounce √©vite les sauvegardes trop fr√©quentes
- La sauvegarde est asynchrone (n'interrompt pas l'utilisateur)
- Utiliser un indicateur de chargement non-bloquant

## Alternatives consid√©r√©es

### Sauvegarde imm√©diate (sans debounce)

‚ùå **Rejet√©e** : Trop d'√©critures disque, ralentit l'application

### Sauvegarde uniquement sur demande

‚ùå **Rejet√©e** : Risque de perte de donn√©es si l'utilisateur oublie de sauvegarder

### Debounce de 5 secondes

‚ùå **Rejet√©e** : Trop long, risque de perte de donn√©es en cas de crash

‚úÖ **Choix retenu** : Debounce de 2 secondes (bon √©quilibre)

## D√©pendances

- US-001-03 : Sauvegarder les donn√©es en fichier TOML
- US-001-04 : Cr√©er un backup automatique avant modification
- State management system (Svelte stores, Redux, etc.)
