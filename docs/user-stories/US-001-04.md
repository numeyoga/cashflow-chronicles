# US-001-04 : Cr√©er un backup automatique avant modification

## Informations g√©n√©rales

- **Epic parent** : EPIC-001 - Stockage et Parser TOML
- **Priorit√©** : Critique
- **Complexit√©** : Faible
- **Sprint** : Sprint 1

## Pr√©requis

- **US-001-01** : Charger un fichier TOML valide
- **US-001-03** : Sauvegarder les donn√©es en fichier TOML

## Profil utilisateur

**Utilisateur final** qui effectue des modifications potentiellement destructrices et a besoin d'un filet de s√©curit√©

## Objectif business

Prot√©ger les donn√©es financi√®res de l'utilisateur contre les pertes accidentelles en cr√©ant automatiquement des sauvegardes avant chaque modification.

## Objectifs concrets

1. Cr√©er une copie du fichier actuel avant toute sauvegarde
2. Nommer le backup avec un timestamp pour tra√ßabilit√©
3. Conserver un historique des N derniers backups (configurable)
4. Permettre la restauration depuis un backup
5. Nettoyer automatiquement les anciens backups
6. Ne pas ralentir la sauvegarde (backup asynchrone si possible)

## Sc√©nario nominal

### √âtapes

1. L'utilisateur modifie des donn√©es et clique sur "Enregistrer"
2. **AVANT** d'√©crire le nouveau fichier, l'application v√©rifie si le fichier actuel existe
3. Si le fichier existe, l'application cr√©e une copie avec le format : `{nom}.{timestamp}.backup.toml`
4. L'application v√©rifie le nombre de backups existants
5. Si plus de N backups (par d√©faut 10), l'application supprime les plus anciens
6. L'application proc√®de √† la sauvegarde normale (US-001-03)
7. Le backup est cr√©√© de mani√®re transparente pour l'utilisateur

## Donn√©es de test

### Donn√©es entrantes

- **Fichier original** : `cashflow-data.toml`
- **Contenu** : Fichier TOML valide avec 5 transactions
- **Date de modification** : 2025-01-15 14:25:33
- **Configuration** : Conserver 10 backups maximum

### Donn√©es sortantes - Backup cr√©√©

**Fichier backup** : `cashflow-data.20250115-142533.backup.toml`

Le contenu du backup est une copie exacte du fichier original avant modification.

### Liste des backups apr√®s plusieurs sauvegardes

```
cashflow-data.toml                        # Fichier actuel
cashflow-data.20250115-142533.backup.toml # Backup 1 (le plus r√©cent)
cashflow-data.20250115-113045.backup.toml # Backup 2
cashflow-data.20250115-092318.backup.toml # Backup 3
...
cashflow-data.20250114-175422.backup.toml # Backup 10 (le plus ancien)
```

### Nettoyage automatique

Si un 11√®me backup est cr√©√©, le plus ancien (`20250114-175422`) est automatiquement supprim√©.

## Crit√®res d'acceptation

- [ ] Un backup est cr√©√© avant chaque sauvegarde
- [ ] Le nom du backup contient un timestamp unique au format `YYYYMMDD-HHMMSS`
- [ ] Le backup est une copie exacte du fichier avant modification
- [ ] Les N derniers backups sont conserv√©s (N configurable, d√©faut = 10)
- [ ] Les backups plus anciens sont automatiquement supprim√©s
- [ ] La cr√©ation du backup n'√©choue pas la sauvegarde principale
- [ ] Le backup est cr√©√© dans le m√™me dossier que le fichier original
- [ ] L'utilisateur peut voir la liste des backups disponibles
- [ ] La cr√©ation du backup ajoute < 50ms au temps de sauvegarde

## Format du nom de fichier backup

```
{nom-fichier-original}.{timestamp}.backup.toml

Exemples :
- cashflow-data.20250115-142533.backup.toml
- budget-2025.20250120-083012.backup.toml
- perso.20250125-194528.backup.toml
```

### Parsing du nom de fichier

```javascript
const backupPattern = /^(.+)\.(\d{8}-\d{6})\.backup\.toml$/;
const match = filename.match(backupPattern);

if (match) {
  const originalName = match[1];     // "cashflow-data"
  const timestamp = match[2];         // "20250115-142533"
  const date = parseTimestamp(timestamp); // Date object
}
```

## Configuration utilisateur

Dans les param√®tres de l'application :

```toml
[settings.backup]
enabled = true              # Activer/d√©sactiver les backups automatiques
maxBackups = 10            # Nombre maximum de backups √† conserver
autoCleanup = true         # Supprimer automatiquement les anciens backups
```

## Interface utilisateur - Liste des backups

### Affichage dans les param√®tres

```
üìã Backups disponibles

‚úì 15/01/2025 14:25:33  (1.2 MB)  [Restaurer] [Supprimer]
‚úì 15/01/2025 11:30:45  (1.2 MB)  [Restaurer] [Supprimer]
‚úì 15/01/2025 09:23:18  (1.1 MB)  [Restaurer] [Supprimer]
...

Total : 10 backups ‚Ä¢ 12.5 MB
```

### Restauration depuis un backup

1. L'utilisateur clique sur [Restaurer]
2. Confirmation : "√ätes-vous s√ªr de restaurer ce backup ? Les modifications non sauvegard√©es seront perdues."
3. Si confirm√© :
   - Cr√©er un backup du fichier actuel
   - Copier le backup s√©lectionn√© vers le fichier principal
   - Recharger l'application
   - Afficher "‚úì Fichier restaur√© depuis le backup du 15/01/2025 14:25:33"

## Gestion des erreurs

### Erreur : Impossible de cr√©er le backup

```
‚ö†Ô∏è Avertissement : Backup impossible

Le backup automatique a √©chou√© mais la sauvegarde va continuer.

Erreur : Espace disque insuffisant

Suggestion : Lib√©rez de l'espace ou d√©sactivez les backups automatiques dans les param√®tres.

[Continuer la sauvegarde] [Annuler]
```

**Note** : Une erreur de backup ne doit PAS bloquer la sauvegarde principale.

## Notes techniques

- Utiliser `fs.copyFile()` (Node.js) ou √©quivalent pour copier le fichier
- Cr√©er le backup de mani√®re synchrone pour garantir qu'il existe avant la sauvegarde
- Lister les backups avec `fs.readdir()` et filtrer par pattern
- Trier par timestamp (du plus r√©cent au plus ancien)
- Logger les op√©rations de backup pour le d√©bogage

## S√©curit√©

- Ne jamais √©craser un backup existant (timestamp unique garanti)
- V√©rifier que le backup a bien √©t√© cr√©√© avant de continuer
- En cas d'√©chec du backup, avertir l'utilisateur mais ne pas bloquer

## Performance

- **Cr√©ation du backup** : < 50ms
- **Nettoyage des anciens backups** : < 20ms
- **Total ajout√© √† la sauvegarde** : < 100ms

## D√©pendances

- US-001-01 : Charger un fichier TOML valide
- US-001-03 : Sauvegarder les donn√©es en fichier TOML
- Acc√®s au syst√®me de fichiers en lecture/√©criture/copie
