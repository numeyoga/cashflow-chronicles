# US-002-01 : Ajouter une nouvelle devise

## Informations g√©n√©rales

- **Epic parent** : EPIC-002 - Gestion des Devises et Taux de Change
- **Priorit√©** : Critique
- **Complexit√©** : Faible
- **Sprint** : Sprint 1-2

## Pr√©requis

- **US-001-01** : Charger un fichier TOML valide (pour charger les devises existantes)
- **US-001-03** : Sauvegarder les donn√©es en fichier TOML (pour persister la nouvelle devise)

## Profil utilisateur

**Utilisateur** qui souhaite g√©rer ses finances dans plusieurs devises (CHF, EUR, USD, etc.)

## Objectif business

Permettre √† l'utilisateur de supporter plusieurs devises pour g√©rer des comptes bancaires internationaux et des transactions multi-devises.

## Objectifs concrets

1. Ajouter une devise avec ses propri√©t√©s (code, nom, symbole, d√©cimales)
2. Valider que le code devise suit la norme ISO 4217
3. Valider que le code devise n'existe pas d√©j√†
4. D√©finir une devise par d√©faut obligatoire
5. Persister la devise dans le fichier TOML
6. Afficher la devise dans la liste des devises

## Sc√©nario nominal

### √âtapes

1. L'utilisateur acc√®de √† **Param√®tres > Devises**
2. L'utilisateur clique sur **[+ Ajouter une devise]**
3. Un formulaire s'affiche avec les champs :
   - Code (3 lettres, obligatoire)
   - Nom (obligatoire)
   - Symbole (obligatoire)
   - D√©cimales (0-8, d√©faut : 2)
   - Par d√©faut (case √† cocher)
4. L'utilisateur saisit :
   - Code : `EUR`
   - Nom : `Euro`
   - Symbole : `‚Ç¨`
   - D√©cimales : `2`
   - Par d√©faut : `non` (CHF est d√©j√† par d√©faut)
5. L'utilisateur clique sur **[Ajouter]**
6. L'application valide les donn√©es (V-CUR-001 √† V-CUR-007)
7. L'application ajoute la devise en m√©moire
8. L'application sauvegarde le fichier TOML
9. L'application affiche : "‚úì Devise EUR ajout√©e avec succ√®s"
10. La devise appara√Æt dans la liste des devises

## Donn√©es de test

### Donn√©es entrantes (formulaire)

```javascript
{
  code: "EUR",
  name: "Euro",
  symbol: "‚Ç¨",
  decimalPlaces: 2,
  isDefault: false
}
```

### Donn√©es sortantes (fichier TOML)

```toml
[[currency]]
code = "CHF"
name = "Swiss Franc"
symbol = "CHF"
decimalPlaces = 2
isDefault = true

[[currency]]
code = "EUR"
name = "Euro"
symbol = "‚Ç¨"
decimalPlaces = 2
isDefault = false  # Optionnel, false par d√©faut
```

### Affichage dans la liste

```
üí± Devises

[+ Ajouter une devise]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CHF - Swiss Franc                  ‚îÇ
‚îÇ CHF ‚Ä¢ Par d√©faut                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ EUR - Euro                          ‚îÇ
‚îÇ ‚Ç¨ ‚Ä¢ 2 d√©cimales                     ‚îÇ
‚îÇ [Modifier] [Supprimer]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Crit√®res d'acceptation

- [ ] Le formulaire d'ajout de devise est accessible
- [ ] Le code devise accepte uniquement 3 lettres majuscules (ISO 4217)
- [ ] La validation emp√™che l'ajout d'un code d√©j√† existant
- [ ] Une seule devise peut √™tre marqu√©e comme "Par d√©faut"
- [ ] Les d√©cimales sont entre 0 et 8
- [ ] La devise est sauvegard√©e dans le fichier TOML
- [ ] La devise appara√Æt imm√©diatement dans la liste
- [ ] Un message de confirmation est affich√©
- [ ] Les devises sont tri√©es par code alphab√©tique

## Validation

### R√®gles appliqu√©es

- **V-CUR-001** : Code ISO 4217 (3 lettres majuscules)
- **V-CUR-002** : Code unique
- **V-CUR-003** : Nom non vide
- **V-CUR-004** : Symbole non vide
- **V-CUR-005** : D√©cimales entre 0 et 8
- **V-CUR-006** : Une seule devise par d√©faut
- **V-CUR-007** : Coh√©rence avec `metadata.defaultCurrency`

### Messages d'erreur

#### Code invalide (non ISO 4217)

```
‚ùå Code devise invalide : "EURO"

Le code doit √™tre un code ISO 4217 valide (3 lettres majuscules).
Exemples : CHF, EUR, USD, GBP, JPY

Suggestion : Utilisez "EUR" au lieu de "EURO"
```

#### Code d√©j√† existant

```
‚ùå Devise d√©j√† existante

Le code "EUR" existe d√©j√† dans votre fichier.

Action : Choisissez un autre code ou modifiez la devise existante.
```

#### D√©cimales hors limites

```
‚ùå Nombre de d√©cimales invalide : 12

Le nombre de d√©cimales doit √™tre entre 0 et 8.

Suggestion : Utilisez 2 pour la plupart des devises.
```

## Devises ISO 4217 les plus courantes

### Pour auto-compl√©tion / suggestions

| Code | Nom | Symbole | D√©cimales |
|------|-----|---------|-----------|
| CHF | Swiss Franc | CHF | 2 |
| EUR | Euro | ‚Ç¨ | 2 |
| USD | US Dollar | $ | 2 |
| GBP | British Pound | ¬£ | 2 |
| JPY | Japanese Yen | ¬• | 0 |
| CAD | Canadian Dollar | CA$ | 2 |
| AUD | Australian Dollar | A$ | 2 |
| CNY | Chinese Yuan | ¬• | 2 |
| INR | Indian Rupee | ‚Çπ | 2 |
| BRL | Brazilian Real | R$ | 2 |

**Note** : Impl√©menter une auto-compl√©tion pour faciliter l'ajout de devises courantes.

## Edge cases (g√©r√©s dans cette US)

### Tentative de d√©finir 2 devises par d√©faut

Si l'utilisateur tente de marquer EUR comme "par d√©faut" alors que CHF l'est d√©j√† :

1. **Option A** : Demander confirmation
   ```
   ‚ö†Ô∏è Changer la devise par d√©faut ?

   CHF est actuellement la devise par d√©faut.
   Voulez-vous la remplacer par EUR ?

   [Oui, changer pour EUR] [Non, garder CHF]
   ```

2. **Option B** (impl√©mentation choisie) : Auto-switch
   - Retirer `isDefault` de CHF
   - Ajouter `isDefault` √† EUR
   - Mettre √† jour `metadata.defaultCurrency`
   - Afficher : "‚úì EUR est maintenant la devise par d√©faut"

### Ajout d'une devise sans symbole

Le symbole est obligatoire. Si vide, utiliser le code comme symbole :

```javascript
if (!currency.symbol || currency.symbol.trim() === "") {
  currency.symbol = currency.code;  // Exemple : "BTC" ‚Üí "BTC"
}
```

## Notes techniques

### Auto-compl√©tion avec liste ISO 4217

```typescript
// Charger une liste compl√®te de devises ISO 4217
import { ISO_4217_CURRENCIES } from './currencies-iso4217';

function searchCurrency(query: string) {
  return ISO_4217_CURRENCIES.filter(c =>
    c.code.includes(query.toUpperCase()) ||
    c.name.toLowerCase().includes(query.toLowerCase())
  );
}
```

### Validation c√¥t√© client

```typescript
function validateCurrency(currency: Currency): ValidationResult {
  const errors = [];

  // V-CUR-001
  if (!/^[A-Z]{3}$/.test(currency.code)) {
    errors.push({ rule: 'V-CUR-001', message: 'Code must be 3 uppercase letters' });
  }

  // V-CUR-002
  if (currencies.some(c => c.code === currency.code)) {
    errors.push({ rule: 'V-CUR-002', message: 'Currency code already exists' });
  }

  // V-CUR-005
  if (currency.decimalPlaces < 0 || currency.decimalPlaces > 8) {
    errors.push({ rule: 'V-CUR-005', message: 'Decimal places must be 0-8' });
  }

  return { valid: errors.length === 0, errors };
}
```

## D√©pendances

- US-001-01 : Charger un fichier TOML valide
- US-001-03 : Sauvegarder les donn√©es en fichier TOML
- US-001-05 : Valider la structure du fichier TOML
- Liste des codes ISO 4217 (fichier de r√©f√©rence ou API)
