# US-001-02 : Gérer les erreurs de parsing TOML

## Informations générales

- **Epic parent** : EPIC-001 - Stockage et Parser TOML
- **Priorité** : Critique
- **Complexité** : Faible
- **Sprint** : Sprint 1

## Prérequis

- **US-001-01** : Charger un fichier TOML valide (fonctionnalité de base)

## Profil utilisateur

**Utilisateur final** qui tente de charger un fichier TOML invalide ou corrompu

## Objectif business

Empêcher l'application de planter en cas de fichier invalide et guider l'utilisateur vers la correction du problème.

## Objectifs concrets

1. Détecter les erreurs de syntaxe TOML
2. Détecter les erreurs d'encodage
3. Afficher un message d'erreur clair et actionnable
4. Indiquer la ligne et la colonne de l'erreur si possible
5. Proposer des suggestions de correction
6. Ne pas charger de données partielles

## Scénario nominal

### Étapes

1. L'utilisateur sélectionne un fichier TOML invalide
2. L'application tente de parser le fichier
3. Le parser détecte une erreur de syntaxe
4. L'application affiche un message d'erreur détaillé avec :
   - Le type d'erreur
   - La localisation (ligne/colonne)
   - Un extrait du fichier autour de l'erreur
   - Une suggestion de correction
5. L'application reste sur l'écran de sélection de fichier
6. Aucune donnée n'est chargée en mémoire

## Données de test

### Données entrantes - Cas 1 : Syntaxe TOML invalide

**Fichier** : `test-invalid-syntax.toml`

```toml
version = "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-01T00:00:00Z
defaultCurrency = "CHF"  # Guillemet manquant ligne 5

[[currency]]
code = CHF  # Guillemets manquants
name = "Swiss Franc"
```

### Données sortantes - Message d'erreur attendu

```
❌ Erreur de parsing TOML

Ligne 5, colonne 45 :
  lastModified = "2025-01-01T00:00:00Z
                                      ^
Erreur : Guillemet de fermeture manquant

Suggestion : Ajouter un guillemet de fermeture à la fin de la valeur
  lastModified = "2025-01-01T00:00:00Z"
```

### Données entrantes - Cas 2 : Encodage invalide

**Fichier** : `test-invalid-encoding.toml` (encodé en ISO-8859-1 au lieu de UTF-8)

### Données sortantes - Message d'erreur attendu

```
❌ Erreur d'encodage

Le fichier n'est pas encodé en UTF-8.

Suggestion :
  - Ouvrez le fichier dans un éditeur de texte
  - Enregistrez-le avec l'encodage UTF-8
  - Réessayez de charger le fichier
```

### Données entrantes - Cas 3 : Section obligatoire manquante

**Fichier** : `test-missing-section.toml`

```toml
version = "1.0.0"

[metadata]
created = "2025-01-01T00:00:00Z"
lastModified = "2025-01-01T00:00:00Z"
defaultCurrency = "CHF"

# Section [[currency]] manquante
```

### Données sortantes - Message d'erreur attendu

```
❌ Fichier TOML incomplet

Sections manquantes :
  - [[currency]]
  - [[account]]
  - [[transaction]]

Suggestion : Le fichier doit contenir toutes les sections requises.
Consultez la documentation pour le format complet.
```

## Critères d'acceptation

- [ ] Les erreurs de syntaxe TOML sont détectées
- [ ] Les erreurs d'encodage sont détectées
- [ ] Les sections manquantes sont détectées
- [ ] Le message d'erreur indique la ligne et la colonne
- [ ] Le message contient une suggestion de correction
- [ ] Aucune donnée partielle n'est chargée
- [ ] L'application ne plante pas
- [ ] L'utilisateur peut réessayer avec un autre fichier

## Scénarios de test

| Scénario | Fichier | Erreur attendue |
|----------|---------|-----------------|
| Guillemet manquant | `test-missing-quote.toml` | Syntaxe TOML invalide ligne X |
| Encodage non-UTF8 | `test-iso8859.toml` | Erreur d'encodage |
| Section manquante | `test-missing-currency.toml` | Section [[currency]] manquante |
| Virgule invalide | `test-invalid-comma.toml` | Syntaxe TOML invalide (TOML n'utilise pas de virgules) |
| Type invalide | `test-invalid-type.toml` | Type de donnée incorrect |

## Notes techniques

- Utiliser un bloc `try-catch` autour du parser TOML
- Logger l'erreur complète en console pour le débogage
- Afficher un message utilisateur simplifié dans l'UI
- Ne pas exposer les détails techniques sensibles
- Tester avec différents types d'erreurs TOML

## Dépendances

- US-001-01 : Charger un fichier TOML valide
